@page "/events/{EventId:int}/discussion"

@using Event_Management_System.Models.Base
@using Event_Management_System.Data
@using Microsoft.EntityFrameworkCore
@using System.Linq


@inject MasDbContext Db
@inject NavigationManager Nav
@inject AuthService Auth

<h2 class="page-title">Discussion</h2>

@if (comments == null)
{
    <p class="loading">Loading...</p>
}
else
{
    <div class="discussion-container">
        @foreach (var c in comments)
        {
            <div class="comment-card">
                <div class="comment-header">
                    <strong>@c.Author.Username</strong>
                   <span class="comment-date">@c.CreatedAt.ToString("dd MMM yyyy HH:mm")</span> 
                </div>

                <p class="comment-content">@c.Content</p>
            </div>
        }
    </div>

    <div class="comment-input-box">
        <textarea class="comment-input"
                  @bind="newComment"
                  placeholder="Write your message..."></textarea>

        <button class="btn-send" @onclick="SendComment">Send</button>
    </div>

    <button class="btn-back" @onclick="GoBack">⬅ Back</button>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert-error">
        @errorMessage
    </div>
}


@code {
    
    [Parameter] public int EventId { get; set; }

    private List<DiscussionComment> comments;
    private User currentUser;
    private Event currentEvent;
    private string newComment = "";
    private string? errorMessage;


    protected override async Task OnInitializedAsync()
    {
        currentUser = await Auth.GetCurrentUserAsync();

        if (currentUser == null)
        {
            errorMessage = "You must be logged in to comment.";
            return;
        }

        currentEvent = await Db.Events
            .FirstOrDefaultAsync(e => e.EventId == EventId);

        if (currentEvent == null)
        {
            errorMessage = "Event not found.";
            return;
        }

        // 🔹 3. Yorumları yükle
        await LoadComments();
    }



    /*protected override async Task OnInitializedAsync()
    {

        // currentUser = await Db.Users.FirstOrDefaultAsync();

        currentEvent = await Db.Events
            .Include(e => e.Enrollments)
            .FirstOrDefaultAsync(e => e.EventId == EventId);

        await LoadComments();
    }*/

    private async Task LoadComments()
    {

        comments = await Db.DiscussionComments
            .Where(d => d.TargetEventId == EventId)
            .Include(d => d.Author)
            .AsNoTracking()       
            .OrderByDescending(d => d.DiscussionCommentId)
            .ToListAsync();
    }

    private async Task SendComment()
    {
        if (string.IsNullOrWhiteSpace(newComment))
            return;

        if (currentUser == null)
        {
            errorMessage = "You must be logged in to comment.";
            return;
        }

        bool isEnrolled = await Db.Enrollments
            .AnyAsync(e => e.UserId == currentUser.UserId && e.EventId == EventId);
        
        bool isOrganizer = currentUser.UserTypes == UserType.Organizer;
        
        if (!isEnrolled && !isOrganizer)
        {
            errorMessage = "You must be enrolled to be able to comment.";
            return;
        }

        var comment = new DiscussionComment(currentUser, currentEvent, newComment);

        Db.DiscussionComments.Add(comment);
        await Db.SaveChangesAsync();

        newComment = "";
        errorMessage = null;

        await LoadComments();
    }


    private void GoBack()
    {
        Nav.NavigateTo($"/events/{EventId}");
    }
}
