@page "/events"
@using Microsoft.EntityFrameworkCore

@inject EventService EventService
@inject NavigationManager Navigation
@inject MasDbContext Db

<h2 class="page-title">Events</h2>

<div class="filter-header">
    <button class="filter-toggle" @onclick="ToggleFilters">
        <span>Filters</span>
        <span class="arrow @(filtersOpen ? "open" : "")">▾</span>
    </button>
</div>


    @if (filtersOpen)
    {
        <div class="filter-bar dropdown">
            <select class="input" @bind="selectedCategoryId">
                <option disabled selected value="">Select category</option>
                @foreach (var cat in categories)
                {
                    <option value="@cat.EventCategoryId">@cat.CategoryName</option>
                }
            </select>

            <input type="date" class="input" @bind="filterStartDate" />
            <input type="date" class="input" @bind="filterEndDate" />

            <button class="btn secondary" @onclick="ShowUpcoming">
                Upcoming Events
            </button>

            <button class="btn secondary" @onclick="ClearFilters">
                Clear Filters
            </button>
            
            <button class="btn apply" @onclick="ApplyFilters">
                Apply Filters
            </button>
        </div>
    }

    @*
    <button class="btn apply" @onclick="ApplyFilters">
        Apply Filters
    </button>

    <button class="btn secondary" @onclick="ShowUpcoming">
        Upcoming Events
    </button>

    <button class="btn secondary" @onclick="ClearFilters">
        Clear Filters
    </button>
    *@
    
<!-- EVENT LIST -->
@if (Events == null)
{
    <p>Loading events...</p>
}
else if (!Events.Any())
{
    <p>No upcoming events.</p>
}
else
{
    <div class="event-grid">
        @foreach (var ev in Events)
        {
            <div class="event-card" @onclick="() => NavigateToDetails(ev.EventId)">

                @if (ev.PromotedRequests.Any(pr => pr.Status == PromotionStatus.Confirmed))
                {
                    <div class="promoted-badge">⭐ Promoted</div>
                }

                <img class="event-image"
                     src="https://picsum.photos/400/250?random=@ev.EventId" />

                <div class="event-content">
                    <h3>@ev.EventTitle</h3>

                    <div class="event-date">
                        <div>
                            <i class="fa-solid fa-play"></i>
                            Start: @ev.StartDate.ToString("dd MMM yyyy - HH:mm")
                        </div>
                        <div>
                            <i class="fa-solid fa-flag-checkered"></i>
                            End: @ev.EndDate.ToString("dd MMM yyyy - HH:mm")
                        </div>
                    </div>

                    <p class="event-location">
                        <i class="fa-solid fa-location-dot"></i>
                        @ev.Venue.Location.City, @ev.Venue.Location.Country
                    </p>

                    <div class="event-categories">
                        @foreach (var cat in ev.Categories)
                        {
                            <span class="category-chip">@cat.CategoryName</span>
                        }
                    </div>

                    <div class="event-footer">
                        <span class="participants">
                            <i class="fa-solid fa-users"></i>
                            @ev.Enrollments.Count participants
                        </span>

                        <span class="join-status not-joined">Details</span>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Event> Events;
    private List<EventCategory> categories = new();

    private int? selectedCategoryId = null;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    
    private bool filtersOpen = false;

    protected override async Task OnInitializedAsync()
    {
        categories = await Db.EventCategories.ToListAsync();
        Events = await EventService.GetAllEventsRankedAsync();
    }

    private void NavigateToDetails(int eventId)
    {
        Navigation.NavigateTo($"/events/{eventId}");
    }

    private async Task ApplyFilters()
    {
        if (selectedCategoryId == null &&
            filterStartDate == null &&
            filterEndDate == null)
        {
            Events = await EventService.GetAllEventsRankedAsync();
            StateHasChanged();
            return;
        }

        Events = await EventService.GetFilteredEventsAsync(
            selectedCategoryId,
            filterStartDate,
            filterEndDate
        );

        StateHasChanged();
    }

    private async Task ClearFilters()
    {
        selectedCategoryId = null;
        filterStartDate = null;
        filterEndDate = null;

        Events = await EventService.GetAllEventsRankedAsync();
        StateHasChanged();
    }


    private async Task ShowUpcoming()
    {
        filterStartDate = DateTime.Today;
        filterEndDate = null;

        Events = await EventService.GetFilteredEventsAsync(
            selectedCategoryId,
            filterStartDate,
            filterEndDate
        );

        StateHasChanged();
    }
    
    private void ToggleFilters()
    {
        filtersOpen = !filtersOpen;
    }
}