@page "/organizer/events"
@using Event_Management_System.Models.Base
@using Microsoft.EntityFrameworkCore

@inject AuthService Auth
@inject MasDbContext Db
@inject NavigationManager Nav
@inject EventService EventService
@inject IJSRuntime JS



<div class="events-container">

    @if (currentUser == null)
    {
        <p class="error-message">You must be logged in.</p>
        <button class="btn" @onclick="GoLogin">Go to Login</button>
    }
    else if (currentUser.UserTypes != UserType.Organizer)
    {
        <p class="error-message">Only organizers can view this page.</p>
        <button class="btn" @onclick="GoHome">Return Home</button>
    }
    else
    {
        <h2 class="page-title">My Events</h2>
        
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <p class="success-message">@successMessage</p>
        }

        @if (!string.IsNullOrEmpty(deleteError))
        {
            <p class="error-message">@deleteError</p>
        }
        
        @if (myEvents.Count == 0)
        {
            <p class="empty-text">You haven't created any events yet.</p>
        }
        else
        {
            <div class="event-list">
                @foreach (var ev in myEvents)
                {
                    <div class="event-card">
                        <img src="https://picsum.photos/400/250?random=@ev.EventId"
                             class="event-image" />

                        <div class="event-info">
                            <h3 class="event-title">@ev.EventTitle</h3>

                            <p class="event-date">
                                📅 @ev.StartDate.ToString("dd MMM yyyy HH:mm")
                            </p>

                            <p class="event-location">
                                📍 @ev.Venue?.Location?.City, @ev.Venue?.Location?.Country
                            </p>

                            <p class="event-participants">
                                👥 @ev.Enrollments.Count participant(s)
                            </p>
                        </div>

                        <div class="event-actions">
                            <button class="btn view-btn"
                                    @onclick="() => ViewEvent(ev.EventId)">
                                View
                            </button>

                            @*
                            <button class="btn promote-btn"
                                    @onclick="() => PromoteEvent(ev.EventId)">
                                Promote
                            </button>*@

                            @if (!IsEventStarted(ev))
                            {
                                <button class="btn edit-btn"
                                        @onclick="() => EditEvent(ev.EventId)">
                                    Edit
                                </button>

                                <button class="btn delete-btn"
                                        disabled="@(deletingEventId == ev.EventId)"
                                        @onclick="() => ConfirmDelete(ev.EventId)">
                                    @(deletingEventId == ev.EventId ? "Deleting..." : "Delete")
                                </button>

                            }
                            else
                            {
                                <span class="event-locked">
            🔒 Event started
        </span>
                            }
                        </div>

                        @*
                        <div class="event-actions">
                            <button class="btn view-btn" @onclick="() => ViewEvent(ev.EventId)">View</button>
                            <button class="btn promote-btn" @onclick="() => PromoteEvent(ev.EventId)">Promote</button>
                        </div>*@
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private User? currentUser;
    private List<Event> myEvents = new();
    private string deleteError = "";
    private int? deletingEventId = null;
    private string successMessage = "";

    protected override async Task OnInitializedAsync()
    {
        currentUser = await Auth.GetCurrentUserAsync();

        if (currentUser != null && currentUser.UserTypes == UserType.Organizer)
        {
            myEvents = await Db.Events
                .Include(e => e.Venue).ThenInclude(v => v.Location)
                .Include(e => e.Enrollments)
                .Where(e => e.Organizer.UserId == currentUser.UserId)
                .OrderByDescending(e => e.StartDate)
                .ToListAsync();
        }
    }

    private bool IsEventStarted(Event ev)
    {
        return DateTime.Now >= ev.StartDate;
    }

    private void EditEvent(int eventId)
    {
        Nav.NavigateTo($"/organizer/events/edit/{eventId}");
    }

    private async Task ConfirmDelete(int eventId)
    {
        if (currentUser == null)
            return;

        deleteError = "";
        successMessage = "";

        bool confirmed = await JsConfirm("Are you sure you want to delete this event?");
        if (!confirmed)
            return;

        try
        {
            deletingEventId = eventId;

            await EventService.DeleteEvent(eventId, currentUser.UserId);

            var ev = myEvents.FirstOrDefault(e => e.EventId == eventId);
            if (ev != null)
                myEvents.Remove(ev);

            successMessage = "Event successfully deleted.";
        }
        catch (Exception ex)
        {
            deleteError = ex.Message;
        }
        finally
        {
            deletingEventId = null;
        }
    }

    private async Task<bool> JsConfirm(string message)
    {
        return await JS.InvokeAsync<bool>("confirm", message);
    }


    // later on, after EventService.cs config!!!!
    private async void DeleteEvent(int eventId)
    {
    }

    
    private void ViewEvent(int id) => Nav.NavigateTo($"/events/{id}");
    // private void PromoteEvent(int id) => Nav.NavigateTo($"/organizer/payment/{id}");

    private void GoLogin() => Nav.NavigateTo("/login");
    private void GoHome() => Nav.NavigateTo("/");
}
