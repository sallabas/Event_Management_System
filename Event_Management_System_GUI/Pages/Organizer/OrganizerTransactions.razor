@page "/organizer/transactions"
@using Microsoft.EntityFrameworkCore
@inject MasDbContext Db
@inject AuthService Auth

<h2 class="title">My Transactions</h2>

@if (transactions == null)
{
    <p>Loading...</p>
}
else if (transactions.Count == 0)
{
    <p>You have no transactions yet.</p>
}
else
{
    <table class="txn-table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Event</th>
            <th>Amount</th>
        </tr>
        </thead>

        <tbody>
        @foreach (var t in transactions)
        {
            <tr>
                <td>@t.TransactionDate.ToString("dd MMM yyyy HH:mm")</td>
                <td>@t.PromotedRequest?.TargetEvent?.EventTitle</td>
                <td>$@t.Amount</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private List<Transaction> transactions;

    protected override async Task OnInitializedAsync()
    {
        var user = await Auth.GetCurrentUserAsync();
        if (user == null)
            return;

        transactions = await Db.Transactions
            .AsNoTracking()
            .Include(t => t.PromotedRequest)
            .ThenInclude(pr => pr.TargetEvent)
            .Include(t => t.PaymentDetail)
            .Where(t => t.PaymentDetail.OwnerUserId == user.UserId)
            .OrderByDescending(t => t.TransactionDate)
            .ToListAsync();
    }
}